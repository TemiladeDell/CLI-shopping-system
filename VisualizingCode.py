products = {
        "Electronics": {
        "Smartphones": {
             "iPhone 14": {"price": 999, "quantity": 50},
            "Samsung Galaxy S23": {"price": 799, "quantity": 100},
            "Google Pixel 7": {"price": 599, "quantity": 200}
        },
        "Laptops": {
            "MacBook Pro": {"price": 1499, "quantity": 30},
            "Dell XPS 15": {"price": 1299, "quantity": 50},
            "HP Spectre x360": {"price": 1199, "quantity": 75}
        },
        "Headphones": {
            "Sony WH-1000XM5": {"price": 349, "quantity": 150},
            "Bose QuietComfort 45": {"price": 329, "quantity": 120},
            "AirPods Pro": {"price": 249, "quantity": 200}
        },
        "Televisions": {
            "LG OLED C2": {"price": 1299, "quantity": 60},
            "Samsung QLED 8K": {"price": 1999, "quantity": 40},
            "Sony Bravia XR": {"price": 1499, "quantity": 50}
        },
        "Gaming Consoles": {
            "PlayStation 5": {"price": 499, "quantity": 200},
            "Xbox Series X": {"price": 499, "quantity": 180},
            "Nintendo Switch": {"price": 299, "quantity": 250}
        }
    },
    "Clothing": {
        "Men’s Wear": {
            "T-Shirt": {"price": 15, "quantity": 500},
            "Jeans": {"price": 40, "quantity": 300},
            "Formal Shirt": {"price": 30, "quantity": 200}
        },
        "Women’s Wear": {
            "Dress": {"price": 50, "quantity": 150},
            "Blouse": {"price": 25, "quantity": 400},
            "Leggings": {"price": 20, "quantity": 450}
        },
        "Kids’ Wear": {
            "Hoodie": {"price": 30, "quantity": 300},
            "Shorts": {"price": 20, "quantity": 400},
            "Sweater": {"price": 25, "quantity": 350}
        },
        "Footwear": {
            "Sneakers": {"price": 60, "quantity": 150},
            "Sandals": {"price": 25, "quantity": 200},
            "Boots": {"price": 80, "quantity": 120}
        },
        "Accessories": {
            "Wristwatch": {"price": 100, "quantity": 50},
            "Belt": {"price": 20, "quantity": 500},
            "Handbag": {"price": 70, "quantity": 150}
        }
    },
    "Food & Groceries": {
        "Fresh Produce": {
            "Apples": {"price": 3, "quantity": 300},
            "Bananas": {"price": 1, "quantity": 400},
            "Carrots": {"price": 2, "quantity": 350}
        },
        "Dairy Products": {
            "Milk": {"price": 4, "quantity": 500},
            "Cheese": {"price": 5, "quantity": 400},
            "Yogurt": {"price": 3, "quantity": 600}
        },
        "Snacks & Beverages": {
            "Chips": {"price": 2, "quantity": 350},
            "Soda": {"price": 1.5, "quantity": 450},
            "Cookies": {"price": 3, "quantity": 500}
        },
        "Frozen Foods": {
            "Frozen Pizza": {"price": 8, "quantity": 250},
            "Ice Cream": {"price": 5, "quantity": 400},
            "Chicken Nuggets": {"price": 10, "quantity": 300}
        },
        "Meat & Seafood": {
            "Chicken Breast": {"price": 7, "quantity": 200},
            "Salmon": {"price": 12, "quantity": 150},
            "Beef Steak": {"price": 15, "quantity": 100}
        }
    },
    "Home & Furniture": {
        "Sofas & Chairs": {
            "Recliner Sofa": {"price": 500, "quantity": 50},
            "Gaming Chair": {"price": 150, "quantity": 100},
            "Wooden Bench": {"price": 200, "quantity": 80}
        },
        "Beds & Mattresses": {
            "Queen Bed": {"price": 700, "quantity": 60},
            "Memory Foam Mattress": {"price": 400, "quantity": 120},
            "Bunk Bed": {"price": 600, "quantity": 90}
        },
        "Kitchenware": {
            "Non-Stick Pan": {"price": 30, "quantity": 300},
            "Blender": {"price": 60, "quantity": 250},
            "Cutlery Set": {"price": 25, "quantity": 400}
        },
        "Storage & Organizers": {
            "Plastic Drawer": {"price": 40, "quantity": 350},
            "Bookshelf": {"price": 120, "quantity": 150},
            "Closet Organizer": {"price": 80, "quantity": 200}
        },
        "Lighting & Decor": {
            "LED Lamp": {"price": 25, "quantity": 450},
            "Wall Art": {"price": 50, "quantity": 100},
            "Curtains": {"price": 40, "quantity": 300}
        }
    },
    "Beauty & Personal Care": {
        "Skincare": {
            "Face Wash": {"price": 10, "quantity": 500},
            "Moisturizer": {"price": 15, "quantity": 400},
            "Sunscreen": {"price": 20, "quantity": 350}
        },
        "Haircare": {
            "Shampoo": {"price": 10, "quantity": 450},
            "Conditioner": {"price": 12, "quantity": 400},
            "Hair Oil": {"price": 8, "quantity": 500}
        },
        "Makeup": {
            "Lipstick": {"price": 18, "quantity": 250},
                 "Foundation": {"price": 25, "quantity": 200},
            "Mascara": {"price": 22, "quantity": 300}
        },
        "Perfumes & Deodorants": {
            "Eau de Parfum": {"price": 50, "quantity": 100},
            "Body Spray": {"price": 20, "quantity": 250},
            "Roll-On Deodorant": {"price": 15, "quantity": 350}
        },
        "Grooming Kits": {
            "Beard Trimmer": {"price": 30, "quantity": 200},
            "Manicure Set": {"price": 15, "quantity": 300},
            "Electric Razor": {"price": 50, "quantity": 150}
        }
    },
    "Sports & Fitness": {
        "Gym Equipment": {
            "Dumbbells": {"price": 40, "quantity": 200},
            "Treadmill": {"price": 600, "quantity": 50},
            "Resistance Bands": {"price": 20, "quantity": 300}
        },
        "Sportswear": {
            "Gym Shorts": {"price": 25, "quantity": 400},
            "Compression Shirt": {"price": 30, "quantity": 350},
            "Sweatpants": {"price": 40, "quantity": 300}
        },
        "Footwear": {
            "Running Shoes": {"price": 70, "quantity": 150},
            "Football Cleats": {"price": 90, "quantity": 100},
            "Basketball Shoes": {"price": 100, "quantity": 120}
        },
        "Supplements & Nutrition": {
            "Protein Powder": {"price": 50, "quantity": 200},
            "Energy Drink": {"price": 3, "quantity": 500},
            "Multivitamins": {"price": 20, "quantity": 350}
        },
        "Outdoor Sports Gear": {
            "Tennis Racket": {"price": 80, "quantity": 150},
            "Basketball": {"price": 30, "quantity": 200},
            "Football": {"price": 25, "quantity": 250}
        }
    },
    "Books & Stationery": {
        "Fiction & Non-Fiction Books": {
            "The Alchemist": {"price": 12, "quantity": 300},
            "Atomic Habits": {"price": 18, "quantity": 200},
            "1984": {"price": 15, "quantity": 250}
        },
        "Educational Books": {
            "Python Programming": {"price": 30, "quantity": 150},
            "Calculus Made Easy": {"price": 25, "quantity": 180},
            "Introduction to AI": {"price": 40, "quantity": 120}
        },
        "Stationery": {
            "Notebook": {"price": 5, "quantity": 500},
            "Pen Set": {"price": 3, "quantity": 600},
            "Markers": {"price": 8, "quantity": 350}
        },
        "Journals & Planners": {
            "Daily Planner": {"price": 15, "quantity": 250},
            "Bullet Journal": {"price": 10, "quantity": 300},
            "Academic Planner": {"price": 18, "quantity": 200}
        },
        "Art Supplies": {
            "Sketchbook": {"price": 12, "quantity": 100},
            "Colored Pencils": {"price": 8, "quantity": 150},
            "Watercolor Set": {"price": 20, "quantity": 120}
        }
    }
}


from datetime import datetime
import json
import random
import os

# Dictionary containing products (not displayed as per instructions)

class Store:
    def __init__(self):
        self.name = "The Orients Store"

    def welcome(self):
        print(f'Welcome to the {self.name}')
        customer_new_or_returning_check = input("Are you a New or Returning Customer?[N/R]: ").strip().lower()
        if customer_new_or_returning_check == "n":
            self.store_customer_data()
        elif customer_new_or_returning_check == "r":
            self.returning_customer()
        else:
            print("Invalid input. Please try again.")
            self.welcome()

    def store_customer_data(self):
        self.product = Product(products)
        self.customer_stay_or_leave = input(
            "Would you like to create an account with us or just browse the shop?\n"
            "1. Browse\n"
            "2. Create Account\n"
            "Enter choice (1 or 2): "
        )

        if self.customer_stay_or_leave == "1":
            self.product.show_categories()
        elif self.customer_stay_or_leave == "2":
            self.create_account()
        else:
            print("Invalid input. Please try again.")
            self.store_customer_data()

    def create_account(self):
        customer_name = input("Enter your name: ")
        customer_email = input("Enter your Email: ")
        customer_address = input("Enter your Address: ")
        customer_phone_number = input("Enter your Phone number: ")
        customer_id = self.generate_random_Ids()

        customer_data = {
            "id": customer_id,
            "name": customer_name,
            "email": customer_email,
            "address": customer_address,
            "number": customer_phone_number,
            "cart": {},
            "Order History": []
        }

        print("Account Created Successfully")
        print(list(customer_data.items())[:4])
        try:
            with open("customers.json", "r") as file:
                customers = json.load(file)
        except (FileNotFoundError, json.JSONDecodeError):
            customers = []
        customers.append(customer_data)
        with open("customers.json", "w") as file:
            json.dump(customers, file, indent=4)
        self.product.show_categories()

    def generate_random_Ids(self):
        if os.path.exists("customers.json"):
            with open("customers.json", "r") as file:
                try:
                    customers = json.load(file)
                except json.JSONDecodeError:
                    customers = []
        else:
            customers = []

        existing_ids = {customer["id"] for customer in customers} if customers else set()

        while True:
            customer_id = str(random.randint(0, 99999)).zfill(5)
            if customer_id not in existing_ids:
                customer_id = "ort" + customer_id
                existing_ids.add(customer_id)
                break

        return customer_id

    def returning_customer(self):
        try:
            if os.path.exists("customers.json"):
                with open("customers.json", "r") as file:
                    run_search_customers = json.load(file)
        except (json.JSONDecodeError, FileNotFoundError):
            print("Your File wasn't found")
            self.store_customer_data()

        customer_search_id = input("Enter your identification number for the store: ").strip().lower()
        for customer in run_search_customers:
            if customer["id"] == customer_search_id:
                return customer
        print("Customer not found. Please create an account.")
        self.store_customer_data()

class Customer:
    def __init__(self):
        self.single_customer_file = Store()
        self.single_customer_data = self.single_customer_file.returning_customer()
        if self.single_customer_data:
            self.customer_cart = self.single_customer_data["cart"]
            self.customer_order_history = self.single_customer_data["Order History"]
            self.customer_selection()
        else:
            print("Customer not found.")
            self.single_customer_file.welcome()

    def customer_selection(self):
        customer_decision = input("What would you like to do?\n1. Browse\n2. Check Cart\n3. Check Order History\n (1, 2, or 3): ").strip().lower()
        if customer_decision == "1":
            Product(products).show_categories()
        elif customer_decision == "2":
            self.check_cart()
        elif customer_decision == "3":
            self.check_order_history()
        else:
            print("Invalid input")
            self.customer_selection()

    def check_cart(self):
        if not self.customer_cart:
            print("Your cart is empty!")
        else:
            print("\nYour cart contains:")
            for product, details in self.customer_cart.items():
                print(f"{product} - {details['quantity']} units at ${details['price']} each")
        
        cart_decision = input("Would you like to:\n1. Continue Browsing\n2. Proceed to Checkout\nEnter choice (1 or 2): ").strip()
        if cart_decision == "1":
            Product(products).show_categories()
        elif cart_decision == "2":
            self.proceed_to_checkout()
        else:
            print("Invalid input")
            self.check_cart()

    def proceed_to_checkout(self):
        if not self.customer_cart:
            print("Your cart is empty! Cannot proceed to checkout.")
            return

        print("\nProceeding to checkout...")
        total = sum(details["price"] * details["quantity"] for details in self.customer_cart.values())
        print(f"Total amount to pay: ${total:.2f}")

        payment_method = PaymentSystem(input("Enter your card number: "), input("Enter expiry date (MM/YY): "))
        payment_result = payment_method.process_payment(total)
        print(payment_result)

        if "successful" in payment_result:
            self.customer_order_history.append({"cart": self.customer_cart, "total": total, "status": "Paid"})
            self.customer_cart.clear()
            print("Thank you for your purchase!")

    def check_order_history(self):
        if not self.customer_order_history:
            print("You have no order history.")
        else:
            print("\nYour order history:")
            for order in self.customer_order_history:
                print(f"Order: {order['cart']}, Total: ${order['total']:.2f}, Status: {order['status']}")

class Product:
    def __init__(self, products):
        self.products = products

    def show_categories(self):
        print("Select a category:")
        for index, category in enumerate(self.products.keys(), start=1):
            print(f"{index}. {category}")

        customer_input = input("Enter a category: ")
        category_list = list(self.products.keys())

        if customer_input.isdigit():
            choice = int(customer_input)
            if 1 <= choice <= len(category_list):
                self.show_subcategories(category_list[choice - 1])
            else:
                print("Invalid choice, try again.")
        else:
            print("Invalid input, please enter a number.")

    def show_subcategories(self, category):
        subcategories = list(self.products[category].keys())
        print(f"\nSelect a subcategory from {category}:")
        for index, sub in enumerate(subcategories, start=1):
            print(f"{index}. {sub}")

        customer_input = input("Enter a subcategory: ")

        if customer_input.isdigit():
            choice = int(customer_input)
            if 1 <= choice <= len(subcategories):
                self.show_products(category, subcategories[choice - 1])
            else:
                print("Invalid choice, try again.")
        else:
            print("Invalid input, please enter a number.")

    def show_products(self, category, subcategory):
        items = self.products[category][subcategory]
        items_list = list(items.keys())

        print(f"\nSelect a product from {subcategory}:")
        for index, item in enumerate(items_list, start=1):
            print(f"{index}. {item}")

        customer_input = input("Enter a product: ")

        if customer_input.isdigit():
            choice = int(customer_input)
            if 1 <= choice <= len(items_list):
                self.show_product_details(category, subcategory, items_list[choice - 1])
            else:
                print("Invalid choice, try again.")
        else:
            print("Invalid input, please enter a number.")

    def show_product_details(self, category, subcategory, product):
        details = self.products[category][subcategory][product]
        print(f"\n{product} - Price: ${details['price']}, Available: {details['quantity']} in stock.")
        self.continue_scrolling(product, details)

    def continue_scrolling(self, product, details):
        customer_Decision_cart_add = input("Would you like to add this item to your cart?[y/n]:  ").strip().lower()
        if customer_Decision_cart_add == "y":
            cart = Cart(Store())
            cart.add_to_cart(product, details)
        elif customer_Decision_cart_add == "n":
            customer_leave_or_stay = input("Would you like to keep browsing or leave \n1.Keep Browsing \n2.Exit\nEnter choice (1 or 2): ").strip().lower()
            if customer_leave_or_stay == "1":
                self.show_categories()
            elif customer_leave_or_stay == "2":
                exit()
            else:
                print("Invalid Input")
                self.continue_scrolling(product, details)

class Cart:
    def __init__(self, store_instance):
        self.items = {}
        self.store = store_instance

    def add_to_cart(self, product, details):
        quantity = int(input(f"How many {product}s would you like to add to cart? "))
        if quantity > details["quantity"]:
            print("Not enough stock available!")
            return

        if product in self.items:
            self.items[product]["quantity"] += quantity
        else:
            self.items[product] = {"price": details["price"], "quantity": quantity}

        print(f"{quantity} {product}(s) added to cart!")

        customer_data_cart = self.store.returning_customer()
        if not customer_data_cart:
            print("You need to create an account to save your cart.")
            self.store.create_account()
            customer_data_cart = self.store.returning_customer()

        customer_data_cart["cart"] = self.items.copy()

        try:
            with open("customers.json", "r") as file:
                customers = json.load(file)
        except (FileNotFoundError, json.JSONDecodeError):
            customers = []

        for cust in customers:
            if cust["id"] == customer_data_cart["id"]:
                cust["cart"] = self.items.copy()
                break

        with open("customers.json", "w") as file:
            json.dump(customers, file, indent=4)

        self.customer_selection_after_adding_to_cart()

    def customer_selection_after_adding_to_cart(self):
        customer_select_view_cart = input("Would you like to:\n1. View Cart\n2. Continue Browsing\nEnter choice (1 or 2): ").strip()
        if customer_select_view_cart == "1":
            self.view_cart()
        elif customer_select_view_cart == "2":
            Product(products).show_categories()
        else:
            print("Invalid input")
            self.customer_selection_after_adding_to_cart()

    def view_cart(self):
        customer_data_cart = self.store.returning_customer()
        cart = customer_data_cart.get("cart", {})
        if not cart:
            print("Your cart is empty.")
            return

        print("\nYour cart contains:")
        for product, details in cart.items():
            print(f"{product} - {details['quantity']} units at ${details['price']} each")

        total = sum(details["price"] * details["quantity"] for details in cart.values())
        print(f"\nTotal: ${total:.2f}")

        while True:
            action = input(
                "\nWhat would you like to do?\n"
                "1. Proceed to Checkout\n"
                "2. Remove an Item from Cart\n"
                "3. Keep Browsing\n"
                "Enter your choice (1, 2, or 3): "
            ).strip()

            if action == "1":
                self.proceed_to_checkout(customer_data_cart, cart, total)
                break
            elif action == "2":
                self.remove_from_cart(customer_data_cart, cart)
                break
            elif action == "3":
                print("Returning to browsing...")
                Product(products).show_categories()
                break
            else:
                print("Invalid choice. Please try again.")

    def proceed_to_checkout(self, customer_data_cart, cart, total):
        print("\nProceeding to checkout...")
        payment_method = PaymentSystem(input("Enter your card number: "), input("Enter expiry date (MM/YY): "))
        payment_result = payment_method.process_payment(total)
        print(payment_result)

        if "successful" in payment_result:
            self.update_order_history(customer_data_cart, cart, total)
            self.clear_cart(customer_data_cart)
            print("Thank you for your purchase!")

    def remove_from_cart(self, customer_data_cart, cart):
        if not cart:
            print("Your cart is empty. Nothing to remove.")
            return

        print("\nYour cart contains:")
        for index, (product, details) in enumerate(cart.items(), start=1):
            print(f"{index}. {product} - {details['quantity']} units at ${details['price']} each")

        item_to_remove = input("Enter the name of the product to remove: ").strip()
        if item_to_remove not in cart:
            print("Item not found in your cart.")
            return

        quantity_to_remove = input(f"How many {item_to_remove}s would you like to remove? ").strip()
        if not quantity_to_remove.isdigit():
            print("Invalid input. Please enter a number.")
            return

        quantity_to_remove = int(quantity_to_remove)
        if quantity_to_remove >= cart[item_to_remove]["quantity"]:
            del cart[item_to_remove]
            print(f"{item_to_remove} removed from your cart.")
        else:
            cart[item_to_remove]["quantity"] -= quantity_to_remove
            print(f"{quantity_to_remove} {item_to_remove}(s) removed from your cart.")

        self.update_cart_in_file(customer_data_cart, cart)

    def update_cart_in_file(self, customer_data_cart, cart):
        try:
            with open("customers.json", "r") as file:
                customers = json.load(file)
        except (FileNotFoundError, json.JSONDecodeError):
            print("Error: Unable to load customer data.")
            return

        for cust in customers:
            if cust["id"] == customer_data_cart["id"]:
                cust["cart"] = cart
                break

        with open("customers.json", "w") as file:
            json.dump(customers, file, indent=4)

    def clear_cart(self, customer_data_cart):
        self.update_cart_in_file(customer_data_cart, {})

    def update_order_history(self, customer_data_cart, cart, total):
        try:
            with open("customers.json", "r") as file:
                customers = json.load(file)
        except (FileNotFoundError, json.JSONDecodeError):
            print("Error: Unable to load customer data.")
            return

        for cust in customers:
            if cust["id"] == customer_data_cart["id"]:
                order = {
                    "cart": cart,
                    "total": total,
                    "status": "Paid"
                }
                cust["Order History"].append(order)
                break

        with open("customers.json", "w") as file:
            json.dump(customers, file, indent=4)

class PaymentSystem:
    def __init__(self, card_number, expiry_date):
        self.card_number = card_number
        self.expiry_date = expiry_date

    def validate_card(self):
        translated_card_number = self.card_number.translate(str.maketrans({' ': '', '-': ''}))
        reversed_card_number = translated_card_number[::-1]
        odd_digits = [int(reversed_card_number[i]) * 2 for i in range(1, len(reversed_card_number), 2)]
        even_digits = [int(reversed_card_number[i]) for i in range(0, len(reversed_card_number), 2)]
        odd_digits = [digit if digit < 10 else digit - 9 for digit in odd_digits]
        checksum = sum(odd_digits) + sum(even_digits)
        return checksum % 10 == 0

    def is_card_expired(self):
        try:
            exp_month, exp_year = map(int, self.expiry_date.split('/'))
            exp_year += 2000
            current_date = datetime.now()
            return current_date.year > exp_year or (current_date.year == exp_year and current_date.month > exp_month)
        except ValueError:
            return True

    def process_payment(self, amount):
        if not self.validate_card():
            return "Payment Failed: Invalid card number!"

        if self.is_card_expired():
            return "Payment Failed: Card has expired!"

        return f"Payment of ${amount:.2f} successful!"

# Main execution
if __name__ == "__main__":
    store = Store()
    store.welcome()